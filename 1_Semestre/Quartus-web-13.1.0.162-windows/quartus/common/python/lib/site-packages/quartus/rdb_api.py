# Copyright 2013 Altera Corporation.
# $Header: //acds/rel/13.1/quartus/ccl/py/rdb_api.py#1 $

"""
Bottle routes for RDB API
"""

__author__ = "Drew MacNeil (dmacneil@altera.com)"
__version__ = "$Revision: #1 $"
__date__ = "$Date: 2013/08/11 $"
__copyright__ = "Copyright 2013 Altera Corporation."


from bottle import route, get, post, request, abort, response

from quartus.tlock import thread_lock

VERSION = "v1.0"

@get("/api/%s/rdb" % VERSION)
@thread_lock
def rdb_api_list():

    api_list = {
        "api" : []
    }
    api_list["api"].append("/api/%s/rdb/panels" % VERSION)
    api_list["api"].append("/api/%s/rdb/panels/<panel_name>" % VERSION)
    
    return api_list

@get("/api/%s/rdb/panels" % VERSION)
@thread_lock
def rdb_panels_index():
    from quartus import dll_loader
    dll_loader.load('db_rdb_rdb')
    from quartus import rdb
    dll_loader.load('comp_qhd_qhd')
    from quartus import qhd
    
    panels_index = {}
    if qhd.is_project_open(): 
        project_name = qhd.get_current_project_name()
        panels_index = rdb.get_toc_dict(project_name)
    return panels_index

@get("/api/%s/rdb/panels/<panel_name>" % VERSION)
@thread_lock
def rdb_get_panel(panel_name):
    from quartus import dll_loader
    dll_loader.load('db_rdb_rdb')
    from quartus import rdb
    dll_loader.load('comp_qhd_qhd')
    from quartus import qhd
    
    panel = {}
    if qhd.is_project_open():
        project_name = qhd.get_current_project_name()
        # Panel names with forward slashes in them have the '/' character
        # substituted with a '^', because otherwise the server would get
        # confused and think the report viewer was requesting another resource.
        # To actually find the panel in RDB, we need to replace the '^' with '/'.
        #
        # TODO: Should have a mechanism to URL encode the panel name, so we 
        #       don't have to do this.
        panel_name = panel_name.replace("^", "/")
        panel = rdb.get_panel_dict(project_name, panel_name)
    
    return panel